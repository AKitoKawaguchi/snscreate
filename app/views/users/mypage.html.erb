<div class="main users-mypage">
<div class="main-edit" style="display: none;">
  <div class="edit-content" style="display: none;">
  <%= form_with url: "/users/#{@user.id}/update", multipart: true do |form| %>
    <div class="edit-content-top">
     <div class="xmark">
      <span class="fa-solid fa-xmark"></span>
     </div>
     <p>プロフィールを編集</p>
     <%=form.submit "保存",class:"edit-save-button"%>
    </div>
    <div class="edit-profile-img">
      <div class="edit-img">
        <label class="image-label">
          <span class="fa-solid fa-camera fa-2x"></span>
          <%=image_tag("/user_images/#{@user.image_name}")%>
          <%=form.file_field :image,class:"image-file"%>
        </label>
      </div>
    </div>
    <div class="edit-profile-name">
      <p>ニックネーム</p>
      <%=form.text_field :name, value:"#{@user.name}", placeholder:"ニックネーム", class:"edit-name-form"%>
    </div>
    <p class="name-caution" style="visibility:hidden;">ニックネームを入力してください</p>
    <div class="edit-profile-comment">
      <p>プロフィール</p>
      <%=form.text_area :profile, value:"#{@user.profile}", placeholder:"プロフィールを追加", class:"edit-profile-form"%>
    </div>
    <div class="edit-user-setting">
      <div class="edit-user-setting-top">
       <p>他のユーザーへの設定</p>
      </div>
      <div class="edit-user-setting-content">
        <div class="edit-user-setting_sec">
          <div class="edit-user-setting-post-top">
            投稿
          </div>
          <div class="edit-user-setting-choice">
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_1, 1,checked: true%>
              <%=form.label :setting_1 ,"表示",value: 1%>
            </div>
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_1, 0,checked: false%>
              <%= form.label :setting_1 ,"非表示",value: 0%>
            </div>
          </div>
        </div>
      </div>
      <div class="edit-user-setting-content">
        <div class="edit-user-setting_sec">
          <div class="edit-user-setting-post-top">
            コメント
          </div>
          <div class="edit-user-setting-choice">
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_2, 1,checked: true%>
              <%=form.label :setting_2 ,"表示",value: 1%>
            </div>
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_2, 0,checked: false%>
              <%= form.label :setting_2 ,"非表示",value: 0%>
            </div>
          </div>
        </div>
      </div>
      <div class="edit-user-setting-content">
        <div class="edit-user-setting_sec">
          <div class="edit-user-setting-post-top">
            いいね
          </div>
          <div class="edit-user-setting-choice">
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_3, 1,checked: true%>
              <%=form.label :setting_3 ,"表示",value: 1%>
            </div>
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_3, 0,checked: false%>
              <%= form.label :setting_3 ,"非表示",value: 0%>
            </div>
          </div>
        </div>
      </div>
      <div class="edit-user-setting-content">
        <div class="edit-user-setting_sec">
          <div class="edit-user-setting-post-top">
            トレーニングカレンダー
          </div>
          <div class="edit-user-setting-choice">
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_4, 1,checked: true%>
              <%=form.label :setting_4 ,"表示",value: 1%>
            </div>
            <div class="edit-user-setting-choice_frac">
              <%=form.radio_button :setting_4, 0,checked: false%>
              <%= form.label :setting_4 ,"非表示",value: 0%>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  </div>
</div>
  <div class="mypage">
    <div class="mypage-section1">
      <div class="user-image">
        <%=image_tag("/user_images/#{@user.image_name}",class: "mypage-image")%>
      </div>
      <div class="mypage-wrap">
        <p class="name"><%=@user.name%></p>
        <div class="profile-detail">
          <%=@user.profile%>
        </div>
        <div class="flex">
        <% if @current_user.id != @user.id%>
          <% if Fav.find_by(follow:@current_user.id,follower:@user.id) %>
            <%=link_to("フォロー解除","/favs/#{@user.id}/unfollow",class: "follow",data:{turbo_method: :post})%>
          <% else %>
            <%=link_to("フォロー","/favs/#{@user.id}/follow",class: "follow",data:{turbo_method: :post})%>
          <% end %>
        <% end %>
        <p><%=link_to("フォロー","/favs/#{@user.id}/followlist")%><%=@follow.count%></p>
        <p><%=link_to("フォロワー","/favs/#{@user.id}/followerlist")%><%=@follower.count%></p>
        <% if @current_user.id == @user.id%>
          <span class="fa-solid fa-gear fa-lg"></span>
        <% end %>
        </div>
      </div>
    </div>
    <div class="mypage-section2">
    <div class="flex">
      <% if @current_user.id == @user.id%>
      <div class="stop">
        <button class="start">トレーニングを開始する</button>
        <div id="clock">
        </div>
        <% if @current_user.id == @user.id%>
          <%=link_to("/users/#{@user.id}/train") do%>
            <button class="recode">詳細を記録する</button>
          <% end %>
        <% end %>
      </div>
      <% end %>
    <div class="train">
      <div class="train-title">
        トレーニングカレンダー
      </div>
      <div class="train-week">
        <div class="day">月</div>
        <div class="day">火</div>
        <div class="day">水</div>
        <div class="day">木</div>
        <div class="day">金</div>
        <div class="day">土</div>
        <div class="day">日</div>
      </div>
      <div class="train-row">
        <div class="train-month">
          <div class="train-month-2">
          </div>
        </div>
        <div class="train-row-parant-child">
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
        </div>
        <div class="train-row-parant-child">
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
        </div>
        <div class="train-row-parant-child">
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
        </div>
        <div class="train-row-parant-child">
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
        </div>
        <div class="train-row-parant-child">
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
          <div class="train-row-child-child"></div>
        </div>
      </div>
    </div>
    </div>
    </div>
    <div class="mypage-section3">
    <div class="choice">
      <div class="posts-mypage-item-post">
        投稿
      </div>
      <div class="posts-mypage-item-reply">
        返信
      </div>
      <div class="posts-mypage-item-like">
        いいね
      </div>
    </div>
    <div class="clear">
    </div>
    <div class="overflow-post">
      <% @user.posts.each do |post|%>
      <% if !post.tocomment %>
      <article class="posts-mypage-post" data-mypage-id="<%= post.to_json %>">
          <div class="post-mypage-content">
            <%=render_with_hashtags(post.content)%>
          </div>
          <div class="post-mypage-option">
            <% comments = Post.where(tocomment:post.id)%>
            <div class="comment">
              <%=link_to("/main/#{post.id}/comment") do %>
                <span class="fa-regular fa-comment"></span>
              <% end %> 
                <%=comments.count %>
            </div>
            <div class="like">
            <% if Like.find_by(user_id:@current_user.id,post_id:post.id) %>
              <%=link_to("/likes/#{post.id}/destroy",data:{turbo_method: :post}) do %>
                <span class="fa-solid fa-heart"></span>
              <% end %>
            <% else %>
              <%=link_to("/likes/#{post.id}/create",data:{turbo_method: :post}) do %>
                <span class="fa-regular fa-heart"></span>
              <% end %>
            <% end %>
              <%=Like.where(post_id:post.id).count%>
            </div>
          </div>
      </article>
      <% end %>
      <% end %>
    </div>
    <div class="overflow-reply none">
      <% @comments.each do |comment|%>
        <% unless comment.like %>
        <div class="posts-mypage-reply" data-reply-id="<%=comment.to_json%>">
          <div class="post-mypage-content">
            <%=comment.content%>
          </div>
          <div class="post-mypage-option">
            <% comments = Post.where(tocomment:comment.id)%>
            <div class="comment">
              <%=link_to("/main/#{comment.id}/comment") do %>
                <span class="fa-regular fa-comment"></span>
              <% end %> 
                <%=comments.count %>
            </div>
            <div class="like">
            <% if Like.find_by(user_id:@current_user.id,post_id:comment.id) %>
              <%=link_to("/likes/#{comment.id}/destroy",data:{turbo_method: :post}) do %>
                <span class="fa-solid fa-heart"></span>
              <% end %>
            <% else %>
              <%=link_to("/likes/#{comment.id}/create",data:{turbo_method: :post}) do %>
                <span class="fa-regular fa-heart"></span>
              <% end %>
            <% end %>
              <%=Like.where(post_id:comment.id).count%>
            </div>
          </div>
        </div>
        <% end %>
      <% end %>
    </div>
    <div class="overflow-fav none">
    <% @likes.each do |like|%>
        <div class="posts-mypage-like" data-like-id="<%=like.post.to_json%>">
        <div class="postname">
          <%=link_to(like.post.user.name,"/users/#{like.post.user.id}")%>
          <%=image_tag "/user_images/#{like.post.user.image_name}", size: "50x50", style: "object-fit:cover; border-radius:50px;" %>
        </div>
        <div class="post-index">
          <%=render_with_hashtags(like.post.content)%>
          <%if like.post.like%>
          <div class="star">
            <% integer = like.post.like.floor %>
            <% integer.times do |i|%>
                <span class="fa-solid fa-star"></span>
            <% end %>
            <% unless like.post.like - integer == 0 %>
                <span class="fa-solid fa-star-half"></span>
            <% end %>
          </div>
          <% end %>
        </div>
          <div class="post-option">
          <% comments = Post.where(tocomment:like.post.id)%>
          <div class="comment">
            <%=link_to("/main/#{like.post.id}/comment") do %>
              <span class="fa-regular fa-comment"></span>
            <% end %> 
              <%=comments.count %>
          </div>
          <div class="like">
          <% if Like.find_by(user_id:@current_user.id,post_id:like.post.id) %>
            <%=link_to("/likes/#{like.post.id}/destroy",data:{turbo_method: :post}) do %>
              <span class="fa-solid fa-heart"></span>
            <% end %>
          <% else %>
            <%=link_to("/likes/#{like.post.id}/create",data:{turbo_method: :post}) do %>
              <span class="fa-regular fa-heart"></span>
            <% end %>
          <% end %>
            <%=Like.where(post_id:like.post.id).count%>
          </div>
        </div> 
        </div>
    <% end %>
    </div>
    </div>
      <div class="mypage-make">
        <span class="fa-regular fa-square-plus fa-2x"></span>
      </div>
      <div class="post-new">
    <div class="post-new-index">
      <div class="post-new-index-top">
        <div class="xmark">
          <i class="fa fa-lg fa-xmark"></i>
        </div>
      </div>
      <div class="post-new-index-content">
        <%=form_with url: "/main/create" do |form|%>
          <div class="post-flex">
            <%=image_tag "/user_images/#{@current_user.image_name}", size: "60x60", style: "object-fit:cover; border-radius: 60px;"%>
            <%=form.text_area :content%>
          </div>
      </div>
        <%=form.button "投稿する", class:"post-new-submit"%>
      <% end %>
    </div>
  </div>
  </div>
</div>


<script type="text/javascript">
    $(function() {
      $(".posts-mypage-post,.posts-mypage-like").removeClass("gray");
      $(".posts-mypage-post,.posts-mypage-like").hover(function(){
        $(this).addClass("gray");
      },function(){
        $(this).removeClass("gray");
      });

      if(<%=@user.id.gsub("-","") != @current_user.id.gsub("-","")%>){
        if(<%=(@user.setting/1000)%10%> === 1){
          $(".posts-mypage-item-post").addClass("white");
        }else if(<%=(@user.setting/100)%10%> === 1){
          $(".posts-mypage-item-reply").addClass("white");
          $(".overflow-reply").removeClass("none");
        }else if(<%=(@user.setting/10)%10%> === 1){
          $(".posts-mypage-item-like").addClass("white");
          $(".overflow-fav").removeClass("none");
        }
        if(<%=(@user.setting/1000)%10%> === 0){
          $(".posts-mypage-item-post").css("display","none")
          $(".overflow-post").css("display","none");
          $("#setting_1_1").checked = false;
          $("#setting_1_0").checked = ture;
        }
        if(<%=(@user.setting/100)%10%> === 0){
          $(".posts-mypage-item-reply").css("display","none")
          $(".overflow-reply").css("display","none");
          $("#setting_2_1").prop("checked",false);
          $("#setting_2_0").prop("checked",true);
        }
        if(<%=(@user.setting/10)%10%> === 0){
          $(".posts-mypage-item-like").css("display","none")
          $(".overflow-fav").css("display","none");
          $("#setting_3_1").checked = false;
          $("#setting_3_0").checked = ture;
        }
        if(<%=(@user.setting/1)%10%> === 0){
          $(".train").css("display","none");
          $("#setting_4_1").checked = false;
          $("#setting_4_0").checked = ture;
        }
      }else{
        if(<%=(@user.setting/1000)%10%> === 0){
          $("#setting_1_1").prop("checked",false);
          $("#setting_1_0").prop("checked",true);
        }
        if(<%=(@user.setting/100)%10%> === 0){
          $("#setting_2_1").prop("checked",false);
          $("#setting_2_0").prop("checked",true);
        }
        if(<%=(@user.setting/10)%10%> === 0){
          $("#setting_3_1").prop("checked",false);
          $("#setting_3_0").prop("checked",true);
        }
        if(<%=(@user.setting/1)%10%> === 0){
          $("#setting_4_1").prop("checked",false);
          $("#setting_4_0").prop("checked",true);
        }
      }
      $(".posts-mypage-item-post").addClass("white");
      $(".posts-mypage-item-reply").on("click",function(){
        $(this).addClass("white");
        $(".overflow-reply").removeClass("none");
        $(".overflow-post").addClass("none");
        $(".overflow-fav").addClass("none");
        $(".posts-mypage-item-post").removeClass("white");
        $(".posts-mypage-item-like").removeClass("white");
      });
      $(".posts-mypage-item-post").on("click",function(){
        $(this).addClass("white");
        $(".overflow-post").removeClass("none");
        $(".overflow-fav").addClass("none");
        $(".overflow-reply").addClass("none");
        $(".posts-mypage-item-reply").removeClass("white");
        $(".posts-mypage-item-like").removeClass("white");
      });
      $(".posts-mypage-item-like").on("click",function(){
        $(this).addClass("white");
        $(".overflow-fav").removeClass("none");
        $(".overflow-post").addClass("none");
        $(".overflow-reply").addClass("none");
        $(".posts-mypage-item-reply").removeClass("white");
        $(".posts-mypage-item-post").removeClass("white");
      });
      $(".posts-mypage-item-notice").on("click",function(){
        $(this).addClass("white");
        $(".overflow-notice").removeClass("none");
        $(".overflow-post").addClass("none");
        $(".overflow-reply").addClass("none");
        $(".overflow-fav").addClass("none");
        $(".posts-mypage-item-reply").removeClass("white");
        $(".posts-mypage-item-post").removeClass("white");
        $(".posts-mypage-item-like").removeClass("white");
      });

    $(".posts-mypage-post").on("click",function(e){
        post = $(this).data("mypage-id");
        if (!$(e.target).closest("a").length){
            window.location.href = `/main/${post.id}`
        }
    });

    $(".posts-mypage-reply").on("click",function(e){
        post = $(this).data("reply-id");
        if (!$(e.target).closest("a").length){
            window.location.href = `/main/${post.id}`
        }
    });

    $(".posts-mypage-like").on("click",function(e){
        post = $(this).data("like-id");
        if (!$(e.target).closest("a").length){
            window.location.href = `/main/${post.id}`
        }
    });


    $(".fa-gear").on("click",function(){
      $(".main-edit").css("display","block");
      $(".edit-content").css("display","block");
    });

    $(".fa-xmark").on("click",function(){
      $(".main-edit").css("display","none");
      $(".edit-content").css("display","none");
    });

    $(".edit-name-form").focus(function(){
      $(".edit-profile-name p").css({"color":"rgb(26,201,250)","font-size":"12px"})
      $(".edit-profile-name").css("border","1px solid rgb(26,201,250)")
      if($(this).val() === ""){
        $(".edit-profile-name").css("border","1px solid red");
      }
    }).blur(function(){
      $(".edit-profile-name p").css({"color":"","font-size":""});
      $(".edit-profile-name").css("border","1px solid #333");
      if($(this).val() === ""){
        $(".edit-profile-name").css("border","1px solid red");
      }
    });

    $(".edit-name-form").on("input",function(){
      if($(this).val() === ""){
        $(".edit-profile-name").css("border","1px solid red");
        $(".edit-profile-name p").css("display","none");
        $(".name-caution").css("visibility","visible");
      }else{
        $(".edit-profile-name").css("border","1px solid #333");
        $(".edit-profile-name p").css("display","");
        $(".name-caution").css("visibility","hidden");
      }
    })

    $(".edit-profile-form").focus(function(){
      $(".edit-profile-comment p").css({"color":"rgb(26,201,250)","font-size":"12px"})
      $(".edit-profile-comment").css("border","1px solid rgb(26,201,250)")
    }).blur(function(){
      $(".edit-profile-comment p").css({"color":"","font-size":""})
      $(".edit-profile-comment").css("border","1px solid #333")
    });

    $(".edit-profile-form").on("input",function(){
      if($(this).val() === ""){
        $(".edit-profile-comment p").css("display","none");
      }else{
        $(".edit-profile-comment p").css("display","");
      }
    })
    

    var sec = 0;
    var min = 0;
    var hour = 0;
    var date = new Date();
    date.setDate(1);
    var today = new Date();
    var point = date.getDay()+today.getDate()-1;
    var todayrow = Math.floor(point/7) + 1;
    var todaycolumn = (point % 7);
    var timer = new Array;
    $(".train-month-2").text(`${today.getMonth()+1}月`);
    $(".start").on("click",function(){
      var day = new Date();
        if ($(this).text() == "トレーニングを開始する"){
            if (!localStorage.getItem(`${today.getMonth()+1}月${today.getDate()}日`)){
              sec = 0;
              min = 0;
              hour = 0;
              $("#clock").html("00:00:00");
            }else{
              storagetime = `${today.getMonth()+1}月${today.getDate()}日`;
              var obj = localStorage.getItem(storagetime);
              object = JSON.parse(obj);
              sec = object.sec;
              min = object.min;
              hour = object.hour;
            }
            timer.push(setInterval(countup, 1000));
            $(this).text("トレーニングをやめる");
            $(this).toggleClass("dark");
        }
        else{
            $(this).text("トレーニングを開始する");
            $(this).toggleClass("dark");
            var now = new Date();
            console.log(timer);
            for (var i = 1; i < 99999; i++){
                if(clearInterval(i)){
                  break;
                }
            }
            stopwatch(hour*60+min,todayrow,todaycolumn);
            storagetime = `${now.getMonth()+1}月${now.getDate()}日`;
            var obj1 = localStorage.getItem(storagetime);
            object = JSON.parse(obj1);
            object.which = "start";
            var obj2 = JSON.stringify(object);
            localStorage.setItem(storagetime,obj2);
        }
    })
    function countup(){
      sec += 1;

      if (sec > 59) {
        sec = 0;
        min += 1;
      }

      if (min > 59) {
        min = 0;
        hour += 1;
      }


      sec_number = ('0' + sec).slice(-2);
      min_number = ('0' + min).slice(-2);
      hour_number = ('0' + hour).slice(-2);

      $('#clock').html(hour_number + ':' +  min_number + ':' + sec_number);
      var obj = {
              sec : sec,
              min : min,
              hour : hour,
              which : "stop"
      };
      var obj = JSON.stringify(obj);
      storagetime = `${today.getMonth()+1}月${today.getDate()}日`;
      localStorage.setItem(storagetime,obj);
      o = localStorage.getItem(storagetime);
      console.log(JSON.parse(o));
      console.log(sec);
    }
    
    function stopwatch(totaltime,row,column){
      if(totaltime >= 90){
                $(`.train-row .train-row-parant-child:nth-child(${row+1}) .train-row-child-child:nth-child(${column})`).addClass("high");
            }else if(totaltime >= 60){
                $(`.train-row .train-row-parant-child:nth-child(${row+1}) .train-row-child-child:nth-child(${column})`).addClass("medium-high");
            }else if(totaltime >= 30){
                $(`.train-row .train-row-parant-child:nth-child(${row+1}) .train-row-child-child:nth-child(${column})`).addClass("medium");
            }else if(totaltime >= 10){
                $(`.train-row .train-row-parant-child:nth-child(${row+1}) .train-row-child-child:nth-child(${column})`).addClass("low");
            }
    }
    for(var s=1;s<=31;s++){
      var jsonObj = localStorage.getItem(`${today.getMonth()+1}月${s}日`);
      console.log(jsonObj);
      pp = date.getDay()+s-1;
      row = Math.floor(pp/7) + 1;
      column = (pp % 7);
      if(jsonObj){
        var jsObj = JSON.parse(jsonObj);
        stopwatch(jsObj.hour*60+jsObj.min,row,column);
      }
      if(s == today.getDate() && jsonObj){
        sec_number = ('0' + jsObj.sec).slice(-2);
        min_number = ('0' + jsObj.min).slice(-2);
        hour_number = ('0' + jsObj.hour).slice(-2);
        $('#clock').html(hour_number + ':' +  min_number + ':' + sec_number);
        break;
      }else{
        $("#clock").html("00:00:00")
      }
    }

    if(localStorage.getItem(`${today.getMonth()+1}月${today.getDate()}日`)){
      var todayObj = localStorage.getItem(`${today.getMonth()+1}月${today.getDate()}日`);
      var object = JSON.parse(todayObj);
      console.log(object);
      if (object.which == "start"){
        $(".start").text("トレーニングを開始する");
        $(".start").removeClass("dark");
      }else if(object.which == "stop"){
        $(".start").text("トレーニングをやめる");
        $(".start").addClass("dark");
      }
    }

    $(".fa-square-plus").on("click",function(){
      $(".post-new").fadeIn();
    })

    $(".fa-xmark").on("click",function(){
      $(".post-new").fadeOut();
    })
    })
</script>